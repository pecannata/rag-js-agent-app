#!/bin/bash

# Mac Deployment Script for RAG-JS-Agent-App
# Run this script to deploy the production build using tmux

echo "ğŸš€ Starting Mac deployment with tmux..."

# Check if tmux is installed
if ! command -v tmux &> /dev/null; then
    echo "âš ï¸  tmux is not installed. Installing with Homebrew..."
    if command -v brew &> /dev/null; then
        brew install tmux
    else
        echo "âŒ Homebrew not found. Please install tmux manually:"
        echo "   brew install tmux"
        echo "   or visit: https://github.com/tmux/tmux/wiki/Installing"
        exit 1
    fi
fi

# Stop any existing production server
echo "Stopping existing production server..."
./stop.mac

# Setup Ollama service and models
echo "Setting up Ollama for local AI capabilities..."
if [ -f "./setup-ollama-models.sh" ]; then
    echo "ğŸ”§ Running Ollama setup script..."
    ./setup-ollama-models.sh
    echo "âœ… Ollama setup completed"
else
    echo "âš ï¸  Ollama setup script not found, using basic service check"
    # Fallback to basic service check
    if brew services list | grep -q "ollama.*started"; then
        echo "âœ… Ollama service is already running"
    else
        echo "ğŸš€ Starting Ollama service..."
        brew services start ollama
        echo "â³ Waiting for Ollama to initialize..."
        sleep 10
        
        # Verify Ollama is responding
        if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
            echo "âœ… Ollama service is ready"
        else
            echo "âš ï¸  Ollama service may not be fully ready yet"
        fi
    fi
fi

# Check and install Python dependencies for document processing
echo "Checking Python dependencies for document processing..."
if [ -f "scripts/requirements.txt" ]; then
    echo "ğŸ“¦ Installing Python dependencies..."
    pip3 install -r scripts/requirements.txt --quiet
    echo "âœ… Python dependencies installed"
else
    echo "âš ï¸  No requirements.txt found, installing basic dependencies..."
    pip3 install PyPDF2 python-docx python-pptx langchain pillow pytesseract --quiet
    echo "âœ… Basic Python dependencies installed"
fi

# Build the project
echo "Building production version..."
npm run build -- --no-lint

# Start production server in tmux session
echo "Starting production server in tmux session..."
SESSION_NAME="rag-js-agent-app"

# Kill existing session if it exists
tmux kill-session -t $SESSION_NAME 2>/dev/null || true

# Create new tmux session and start the server
tmux new-session -d -s $SESSION_NAME -c "$(pwd)" 'PORT=3020 npm start 2>&1 | tee production.log'

# Wait a moment for server to start
echo "Waiting for server to initialize..."
sleep 5

# Check if server is running
echo "Checking server status..."
STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3020)

if [ "$STATUS" = "200" ]; then
    echo "âœ… Production server is running successfully!"
    echo "ğŸ“ URL: http://localhost:3020"
    echo "ğŸ–¥ï¸  tmux session: $SESSION_NAME"
    echo "ğŸ“ View logs: tail -f production.log"
    echo "ğŸ” Check session: tmux ls"
    echo "ğŸ–±ï¸  Attach to session: tmux attach -t $SESSION_NAME"
    echo "ğŸ›‘ Stop server: ./stop.mac"
    echo ""
    echo "ğŸ¯ The server will continue running even after you close this terminal."
    echo "   To monitor: tmux attach -t $SESSION_NAME"
    echo "   To detach: Ctrl+B, then D"
else
    echo "âŒ Server failed to start properly"
    echo "ğŸ“ Check production.log for errors: tail -f production.log"
    echo "ğŸ” Check tmux session: tmux attach -t $SESSION_NAME"
fi
