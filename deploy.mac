#!/bin/bash

# Mac Deployment Script for RAG-JS-Agent-App
# Run this script to deploy the production build

echo "🚀 Starting Mac deployment..."

# Stop any existing production server
echo "Stopping existing production server..."
pkill -f "npm start" || true
pkill -f "next-server" || true

# Build the project
echo "Building production version..."
npm run build -- --no-lint

# Start production server in background with nohup
echo "Starting production server in background..."
nohup npm start > production.log 2>&1 &

# Capture the process ID
PID=$!
echo "📋 Process started with PID: $PID"

# Save PID to file for easy management
echo $PID > app.pid

# Wait a moment for server to start
echo "Waiting for server to initialize..."
sleep 5

# Check if server is running
echo "Checking server status..."
STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)

if [ "$STATUS" = "200" ]; then
    echo "✅ Production server is running successfully!"
    echo "📍 URL: http://localhost:3000"
    echo "🆔 Process ID: $PID"
    echo "📝 View logs: tail -f production.log"
    echo "🔍 Check status: ps -p $PID"
    echo "🛑 Stop server: kill $PID  (or pkill -f 'npm start')"
    echo ""
    echo "🎯 The server will continue running even after you close this terminal."
    echo "   To stop it later, use: kill $PID"
else
    echo "❌ Server failed to start properly"
    echo "📝 Check production.log for errors: tail -f production.log"
    echo "🔍 Check if process is still running: ps -p $PID"
fi
